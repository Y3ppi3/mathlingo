// src/hooks/useUser.ts
import { useState, useEffect, useCallback } from 'react';
import { useAuth } from '../context/AuthContext';
import { getLocalUserData, updateLocalUserData } from '../utils/LocalUserStorage';

interface User {
    id: number;
    username: string;
    email: string;
    avatarId?: number;
}

export function useUser() {
    const { isAuthenticated } = useAuth();
    const [user, setUser] = useState<User | null>(null);
    const [loading, setLoading] = useState<boolean>(true);
    const [error, setError] = useState<string | null>(null);
    const [forceUpdate, setForceUpdate] = useState<number>(0); // –î–æ–±–∞–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const fetchUser = useCallback(async () => {
        if (!isAuthenticated) {
            setUser(null);
            setLoading(false);
            return null;
        }

        try {
            setLoading(true);
            const API_URL = import.meta.env.VITE_API_URL;

            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ localStorage
            const savedUsername = localStorage.getItem('user_username');
            const savedId = localStorage.getItem('user_id');
            const savedEmail = localStorage.getItem('user_email');
            const savedAvatarId = localStorage.getItem('user_avatar_id');

            if (savedId && savedUsername && savedEmail) {
                const localUser: User = {
                    id: parseInt(savedId),
                    username: savedUsername,
                    email: savedEmail,
                    avatarId: savedAvatarId ? parseInt(savedAvatarId) : undefined
                };

                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π localStorage:', localUser);
                setUser(localUser);
                setError(null);
                setLoading(false);
                return localUser;
            }

            // –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –≤ localStorage
            const localUserData = getLocalUserData();
            if (localUserData) {
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage:', localUserData);
                setUser(localUserData);
                setError(null);
                setLoading(false);
                return localUserData;
            }

            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ localStorage, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
            try {
                const response = await fetch(`${API_URL}/api/me`, {
                    method: "GET",
                    credentials: "include",
                    headers: { "Content-Type": "application/json" },
                });

                if (response.ok) {
                    const userData = await response.json();
                    console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', userData);
                    setUser(userData);

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ localStorage
                    localStorage.setItem('user_username', userData.username);
                    localStorage.setItem('user_id', userData.id.toString());
                    localStorage.setItem('user_email', userData.email);
                    localStorage.setItem('user_avatar_id', userData.avatarId?.toString() || '');

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é updateLocalUserData
                    updateLocalUserData(userData);

                    setError(null);
                    return userData;
                } else {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...
                    if (process.env.NODE_ENV === 'development') {
                        console.log('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ');
                        const testUser = {
                            id: 1,
                            username: "–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                            email: "test@example.com",
                            avatarId: 1
                        };
                        setUser(testUser);
                        updateLocalUserData(testUser);
                        setError(null);
                        return testUser;
                    } else {
                        setUser(null);
                        setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                        return null;
                    }
                }
            } catch (err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ API:', err);

                // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
                if (process.env.NODE_ENV === 'development') {
                    const testUser = {
                        id: 1,
                        username: "–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                        email: "test@example.com",
                        avatarId: 1
                    };
                    setUser(testUser);
                    updateLocalUserData(testUser);
                    setError(null);
                    return testUser;
                } else {
                    setError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return null;
                }
            }
        } finally {
            setLoading(false);
        }
    }, [isAuthenticated, forceUpdate]); // –î–æ–±–∞–≤–ª—è–µ–º forceUpdate –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const updateUserProfile = async (data: {username?: string, avatarId?: number | null}) => {
        if (!user) {
            throw new Error("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
        }

        const controller = new AbortController();
        const signal = controller.signal;

        try {
            console.log("üìù –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", data);
            const API_URL = import.meta.env.VITE_API_URL;

            const response = await fetch(`${API_URL}/api/me/update`, {
                method: "PUT",
                credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
                signal
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.detail || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å");
            }

            // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞
            const updatedUserData = await response.json();
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', updatedUserData);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ localStorage
            setUser(updatedUserData);

            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            localStorage.setItem('user_username', updatedUserData.username);
            localStorage.setItem('user_id', updatedUserData.id.toString());
            localStorage.setItem('user_email', updatedUserData.email);
            localStorage.setItem('user_avatar_id', updatedUserData.avatarId?.toString() || '');

            // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é
            updateLocalUserData(updatedUserData);

            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            setForceUpdate(prev => prev + 1);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
            window.dispatchEvent(new CustomEvent('userDataUpdated', {
                detail: updatedUserData
            }));

            return { success: true, data: updatedUserData };
        } catch (err) {
            if (err.name === 'AbortError') {
                console.log('–ó–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω');
                return { success: false, canceled: true };
            }

            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:", err);
            throw err;
        } finally {
            controller.abort();
        }
    };

    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    useEffect(() => {
        const handleUserDataUpdate = (event: Event) => {
            const customEvent = event as CustomEvent<User>;
            setUser(customEvent.detail);
        };

        window.addEventListener('userDataUpdated', handleUserDataUpdate);

        return () => {
            window.removeEventListener('userDataUpdated', handleUserDataUpdate);
        };
    }, []);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    useEffect(() => {
        let isMounted = true;

        const loadUserData = async () => {
            try {
                await fetchUser();
            } catch (err) {
                if (isMounted) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', err);
                }
            }
        };

        loadUserData();

        return () => {
            isMounted = false;
        };
    }, [fetchUser]);

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –¥–æ—Å—Ç—É–ø–Ω–∞—è –∏–∑–≤–Ω–µ
    const refreshUserData = async () => {
        const userData = await fetchUser();
        if (userData) {
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            setForceUpdate(prev => prev + 1);
        }
        return userData;
    };

    return {
        user,
        loading,
        error,
        getAvatarUrl: (avatarId?: number) => avatarId ? `/avatars/${avatarId}.png` : undefined,
        updateUserProfile,
        refreshUserData
    };
}